import y from"puppeteer";import{createClient as S}from"redis";import*as v from"dotenv";v.config();var k=process.env.REDIS_URL,l=S({url:k});async function w(a,e){await l.connect(),await l.set(a,e),await l.disconnect()}async function m(a){await l.connect();let e=await l.get(a);return await l.disconnect(),e}var d=class{browser;async create(){let e=2,i=0;do try{i++;let t=await m("wsEndpoint");if(t)return this.browser=await y.connect({browserWSEndpoint:t}),console.log("Browser connected"),console.log("WS Endpoint: "+t),this.browser;if(!t){let o=["--autoplay-policy=user-gesture-required","--disable-background-networking","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-breakpad","--disable-client-side-phishing-detection","--disable-component-update","--disable-default-apps","--disable-dev-shm-usage","--disable-domain-reliability","--disable-extensions","--disable-features=AudioServiceOutOfProcess","--disable-hang-monitor","--disable-ipc-flooding-protection","--disable-notifications","--disable-offer-store-unmasked-wallet-cards","--disable-popup-blocking","--disable-print-preview","--disable-prompt-on-repost","--disable-renderer-backgrounding","--disable-setuid-sandbox","--disable-speech-api","--disable-sync","--hide-scrollbars","--ignore-gpu-blacklist","--metrics-recording-only","--mute-audio","--no-default-browser-check","--no-first-run","--no-pings","--no-zygote","--password-store=basic","--use-gl=swiftshader","--use-mock-keychain","--no-sandbox"];return this.browser=await y.launch({headless:!0,args:o}),t=this.browser.wsEndpoint(),await w("wsEndpoint",t),console.log("Browser created"),console.log("WS Endpoint: "+t),this.browser}}catch(t){i===e?(console.log(t),console.log("Error at starting browser")):await w("wsEndpoint","")}while(i<e)}};import*as b from"dotenv";import P from"axios";import g from"fs";b.config();var p=class{constructor(e){this.browser=e}page;async start(){try{this.page=await this.browser.newPage(),await this.page.setViewport({width:600,height:600}),await this.page.goto("https://p2p.binance.com/trade/all-payments/USDT?fiat=AED"),console.log("Page loaded"),await this.setUpSiteSettings(),console.log("Selecting currency"),await this.delay(1);let e=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div'),i=await this.page.$(e);if(!i){console.log("Currency input not found"),await this.sendToTelegram("Currency input not found");return}console.log("Clicking over currency input"),await i.click(),await this.delay(1),console.log("Searching currency");let t=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div[2]/div/div/div[1]/div/input'),o=await this.page.$(t);if(!o){console.log("Currency search input not found"),await this.sendToTelegram("Currency search input not found");return}console.log("Typing MMK"),await o.type("MMK",{delay:200}),await this.delay(1),console.log("Clicking currency button");let r=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div[2]/div/div/div[2]/div/div'),s=await this.page.$(r);if(!s){console.log("Currency button not found"),await this.sendToTelegram("Currency search input not found");return}await s.click(),console.log("Currency selected"),await this.delay(2),console.log("Selecting first item");let _=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[3]/div/div[1]/div[1]/div[2]/div[1]/div/div[1]'),f=await this.page.$(_);if(!f){console.log("First item not found"),await this.sendToTelegram("Currency search input not found");return}console.log("Selected first item");let n=await this.page.evaluate(u=>u.textContent,f);if(n){let u=/[^0-9]/g;n=n.replace(u,"");let c=process.env.BUY_PRICE_THRESHOLD;c=c||"0",console.info("Price threshold "+c),console.info("Price: "+n),n<=c&&await this.sendBuyPriceAlert(c,n)}await this.page.close(),await this.browser.disconnect(),console.log("Browser disconnected")}catch(e){console.log(e)}}xpath(e){return`::-p-xpath(${e})`}async delay(e){return new Promise(i=>{setTimeout(i,e*1e3)})}async sendBuyPriceAlert(e,i){await this.sendToTelegram(`Price is below threshold
Threshold: ${e}
Price: ${i}`)}async sendToTelegram(e){let t=`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,o=process.env.TELEGRAM_GROUP_ID,r={chat_id:o||"",text:e};await P.get(t,{params:r}).then(s=>{console.log("Telegram API response:",s.data)}).catch(s=>{console.error("Error sending message to Telegram:",s.message),s.response&&(console.error("Response status:",s.response.status),console.error("Response data:",s.response.data))})}async storeSiteSettings(){let e=await this.page.cookies();g.writeFileSync("site-settings/cookies.json",JSON.stringify(e,null,2));let i=await this.page.evaluate(()=>{let t={};for(let o=0;o<localStorage.length;o++){let r=localStorage.key(o);r&&(t[r]=localStorage.getItem(r))}return t});g.writeFileSync("site-settings/local_storage.json",JSON.stringify(i,null,2))}async setUpSiteSettings(){let e=g.readFileSync("site-settings/cookies.json","utf-8");e&&await this.page.setCookie(...JSON.parse(e));let i=g.readFileSync("site-settings/local_storage.json","utf-8");i&&await this.page.evaluate(t=>{for(let o in t)localStorage.setItem(o,t[o])},JSON.parse(i)),await this.page.reload(),await this.delay(2)}};var h=!1;(async()=>setInterval(async()=>{h||(h=!0,await T(),h=!1)},5e3))();async function T(){let a=await new d().create();if(!a){console.log("Browser not created");return}await new p(a).start()}
//# sourceMappingURL=start_scraper.js.map
