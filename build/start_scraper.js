import m from"puppeteer";import{createClient as b}from"redis";var s=b();async function u(o,e){await s.connect(),await s.set(o,e),await s.disconnect()}async function f(o){await s.connect();let e=await s.get(o);return await s.disconnect(),e}var c=class{browser;async create(){let e=2,i=0;do try{i++;let t=await f("wsEndpoint");if(t)return this.browser=await m.connect({browserWSEndpoint:t}),console.log("Browser connected"),this.browser;if(!t)return this.browser=await m.launch({userDataDir:"./user_data",headless:!0}),t=this.browser.wsEndpoint(),await u("wsEndpoint",t),console.log("Browser created"),this.browser}catch{i===e?console.log("Error at starting browser"):await u("wsEndpoint","")}while(i<e)}};import*as h from"dotenv";import x from"axios";h.config();var l=class{constructor(e){this.browser=e}async start(){try{let e=await this.browser.newPage();await e.goto("https://p2p.binance.com/trade/all-payments/USDT?fiat=AED"),console.log("Page loaded"),console.log("Selecting currency"),await this.delay(1);let i=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[1]/div[2]/div/div/div[1]'),t=await e.$(i);if(!t){console.log("Currency input not found");return}console.log("Hovering over currency input"),await t.hover();let p=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[1]/div[2]/div/div/div[2]/div/div/div[2]/div'),d=Array.from(await e.$$(p));if(!d.length){console.log("Currency buttons not found");return}console.log("Clicking currency button");let v=!1;for(let n=0;n<d.length;n++){let r=await e.evaluate(_=>_.textContent,d[n]);if(r=r?r.trim():"",r==="MMK"){await d[n].click(),v=!0;break}}if(!v){console.log("Currency not found");return}console.log("Currency selected"),await this.delay(2),console.log("Selecting first item");let y=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[3]/div/div[1]/div[1]/div[2]/div[1]/div/div[1]'),g=await e.$(y);if(!g){console.log("First item not found");return}console.log("Selected first item");let a=await e.evaluate(n=>n.textContent,g);if(a){let n=/[^0-9]/g;a=a.replace(n,"");let r=process.env.BUY_PRICE_THRESHOLD;r=r||"0",console.info("Price: "+a),a<=r&&await this.sendToTelegram(a)}await e.close(),await this.browser.disconnect(),console.log("Browser disconnected")}catch(e){console.log(e)}}xpath(e){return`::-p-xpath(${e})`}async delay(e){return new Promise(i=>{setTimeout(i,e*1e3)})}async sendToTelegram(e){let t=`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,p={chat_id:process.env.TELEGRAM_GROUP_ID,text:`Price: ${e}`};await x.get(t,{params:p})}};var w=!1;(async()=>setInterval(async()=>{w||(w=!0,await P(),w=!1)},5e3))();async function P(){let o=await new c().create();if(!o){console.log("Browser not created");return}await new l(o).start()}
//# sourceMappingURL=start_scraper.js.map
