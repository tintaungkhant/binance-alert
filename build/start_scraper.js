import b from"puppeteer";import{createClient as x}from"redis";import*as v from"dotenv";v.config();var P=process.env.REDIS_URL,n=x({url:P});async function p(i,e){await n.connect(),await n.set(i,e),await n.disconnect()}async function h(i){await n.connect();let e=await n.get(i);return await n.disconnect(),e}var s=class{browser;async create(){let e=2,o=0;do try{o++;let t=await h("wsEndpoint");if(t)return this.browser=await b.connect({browserWSEndpoint:t}),console.log("Browser connected"),console.log("WS Endpoint: "+t),this.browser;if(!t){let a=["--autoplay-policy=user-gesture-required","--disable-background-networking","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-breakpad","--disable-client-side-phishing-detection","--disable-component-update","--disable-default-apps","--disable-dev-shm-usage","--disable-domain-reliability","--disable-extensions","--disable-features=AudioServiceOutOfProcess","--disable-hang-monitor","--disable-ipc-flooding-protection","--disable-notifications","--disable-offer-store-unmasked-wallet-cards","--disable-popup-blocking","--disable-print-preview","--disable-prompt-on-repost","--disable-renderer-backgrounding","--disable-setuid-sandbox","--disable-speech-api","--disable-sync","--hide-scrollbars","--ignore-gpu-blacklist","--metrics-recording-only","--mute-audio","--no-default-browser-check","--no-first-run","--no-pings","--no-sandbox","--no-zygote","--password-store=basic","--use-gl=swiftshader","--use-mock-keychain"];return this.browser=await b.launch({userDataDir:"./user_data",headless:!0,args:a}),t=this.browser.wsEndpoint(),await p("wsEndpoint",t),console.log("Browser created"),console.log("WS Endpoint: "+t),this.browser}}catch(t){o===e?(console.log(t),console.log("Error at starting browser")):await p("wsEndpoint","")}while(o<e)}};import*as m from"dotenv";import k from"axios";m.config();var c=class{constructor(e){this.browser=e}async start(){try{let e=await this.browser.newPage();await e.setViewport({width:600,height:600}),await e.goto("https://p2p.binance.com/trade/all-payments/USDT?fiat=AED"),console.log("Page loaded"),await e.screenshot({path:"screenshot.png"}),console.log("Selecting currency"),await this.delay(1);let o=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div'),t=await e.$(o);if(!t){console.log("Currency input not found");return}console.log("Clicking over currency input"),await t.click(),await this.delay(1),console.log("Searching currency");let a=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div[2]/div/div/div[1]/div/input'),u=await e.$(a);if(!u){console.log("Currency search input not found");return}console.log("Typing MMK"),await u.type("MMK",{delay:200}),await this.delay(1),console.log("Clicking currency button");let y=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[1]/div/div[2]/div[2]/div/div[2]/div/div/div[2]/div/div'),w=await e.$(y);if(!w){console.log("Currency button not found");return}await w.click(),console.log("Currency selected"),await this.delay(2),console.log("Selecting first item");let _=this.xpath('//*[@id="__APP"]/div/div[2]/main/div[2]/div[3]/div/div[1]/div[1]/div[2]/div[1]/div/div[1]'),g=await e.$(_);if(!g){console.log("First item not found");return}console.log("Selected first item");let r=await e.evaluate(l=>l.textContent,g);if(r){let l=/[^0-9]/g;r=r.replace(l,"");let d=process.env.BUY_PRICE_THRESHOLD;d=d||"0",console.info("Price: "+r),r<=d&&await this.sendToTelegram(r)}await e.close(),await this.browser.disconnect(),console.log("Browser disconnected")}catch(e){console.log(e)}}xpath(e){return`::-p-xpath(${e})`}async delay(e){return new Promise(o=>{setTimeout(o,e*1e3)})}async sendToTelegram(e){let t=`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,a={chat_id:process.env.TELEGRAM_GROUP_ID,text:`Price: ${e}`};await k.get(t,{params:a})}};var f=!1;(async()=>setInterval(async()=>{f||(f=!0,await E())},5e3))();async function E(){let i=await new s().create();if(!i){console.log("Browser not created");return}await new c(i).start()}
//# sourceMappingURL=start_scraper.js.map
